
--- Endpoint Analysis ---

‚Ä¢ Endpoint Security Controls 
‚Ä¢ Windows Network Analysis 
‚Ä¢ Windows Process Analysis  
‚Ä¢ Windows Core Processes
‚Ä¢ The Windows Registry  
‚Ä¢ Windows Autoruns
‚Ä¢ Windows Service Analysis  
‚Ä¢ Windows Scheduled Tasks  
‚Ä¢ Windows Event Logs  
‚Ä¢ Introduction to Sysmon  
‚Ä¢ Sysmon   
‚Ä¢ Linux Network Analysis  
‚Ä¢ Linux Process Analysis  
‚Ä¢ Linux Cron Jobs  



-- Endpoint Security Controls --

Endpoint Security Controls:

‚Ä¢ Antivirus / Antimalware
  ‚Üí Scans files and activities
  ‚Üí Matches patterns and signatures
‚Ä¢ Endpoint Detection and Response (EDR)
  ‚Üí Real-time monitoring and response
  ‚Üí Agent-based deployment
  ‚Üí Monitors process, file, registry, and network activity
‚Ä¢ Extended Detection and Response (XDR)
  ‚Üí Integration of multiple security controls and telemetry
  ‚Üí Runbooks and automated response to routine threats
‚Ä¢ Data Loss Prevention (DLP)
  ‚Üí Protects sensitive data at rest, transit, and in processing
  ‚Üí Access controls, data masking, and prevention
‚Ä¢ User and Entity Behavior Analytics (UBA)
  ‚Üí Monitors user behavior patterns
  ‚Üí Detects deviations from historic and contextual baselines
  ‚Üí Identifies insider threats, account compromise, and data exfiltration
‚Ä¢ HIDS / HIPS
  ‚Üí HIDS: Host-based Intrusion Detection System
  ‚Üí HIPS: Host-based Intrusion Prevention System
‚Ä¢ Host-based Firewall
  ‚Üí Controls incoming and outgoing traffic on a host

Endpoint Security Monitoring

‚Ä¢ Process Execution
  ‚Üí Monitoring running processes
  ‚Üí Executable files, PIDs, and command-line arguments
  ‚Üí Parent-child process hierarchy
‚Ä¢ File System Changes
  ‚Üí Creation, modification, and deletion
  ‚Üí File Integrity Monitoring (FIM)
‚Ä¢ Network Connections
  ‚Üí Traffic and connections initiated from the endpoint
  ‚Üí Associated processes and executables
‚Ä¢ Registry Modifications
  ‚Üí Monitor registry keys and values
  ‚Üí Detect backdoors, persistence, and detection evasion



-- Windows Network Analysis --

üîß CMD Network Commands

net share ‚Üí View local shares
net share Exfil=C:\Users\admin\Downloads\exfil ‚Üí Create a share named ‚ÄúExfil‚Äù pointing to a folder (mount for sharing)
net use X: \127.0.0.1\Exfil ‚Üí Map network share Exfil to drive X:
net use ‚Üí Show mapped drives and active sessions
net view ‚Üí List computers and visible shares on the network
net view \127.0.0.1\ ‚Üí View shares on the local machine (by IP)
net view \HOSTNAME ‚Üí View shares on a specific host
net share \127.0.0.1\ ‚Üí Show local shares via IP path
net session ‚Üí Show active SMB sessions on this machine


üåê Network Statistics

netstat -anob ‚Üí Show all active connections with owning process/EXE
netstat -anob [ESTABLISHED] ‚Üí Show only established connections
netstat -e ‚Üí Display Ethernet statistics
netstat -nr ‚Üí Show routing table (numeric mode)
netstat -S ‚Üí Display per-protocol statistics
netstat -vb ‚Üí Show verbose info including the executable (admin required)


üì° IP / ARP / Routing

ipconfig /all ‚Üí Show detailed adapter configuration
arp -a ‚Üí View ARP cache (IP-to-MAC mappings)
route print ‚Üí Display system routing table
nbtstat -n ‚Üí Show local NetBIOS name table
nbtstat -A [IP] ‚Üí Display remote NetBIOS information


‚ö° PowerShell Network Commands

Get-NetAdapter ‚Üí View network interface card info
Get-NetIPAddress ‚Üí Display IPv4 and IPv6 configuration
Get-NetIPConfiguration ‚Üí Show full IP configuration
Get-NetRoute ‚Üí Display routing table

Get-NetTCPConnection ‚Üí Show active TCP connections (netstat equivalent)
Get-NetUDPEndpoint ‚Üí Display active UDP ports

Get-SmbShare ‚Üí View SMB shared folders
Get-SmbSession ‚Üí Show active SMB sessions
Get-SmbMapping ‚Üí Display mapped network drives
New-SmbShare -Name X -Path C:\ ‚Üí Create a new SMB share

Resolve-DnsName google.com ‚Üí Perform DNS lookup (like nslookup)
Test-Connection google.com ‚Üí Ping alternative using PowerShell
Test-NetConnection -Port 80 ‚Üí Test port connectivity

Get-NetFirewallRule ‚Üí View firewall rules
Get-NetFirewallProfile ‚Üí Check firewall status


üß† WMI-Based Network Enumeration

Get-WmiObject Win32_NetworkAdapterConfiguration ‚Üí Show NICs with IPs, MACs, and gateways
Get-WmiObject Win32_NetworkAdapter ‚Üí Display all network adapters
Get-WmiObject Win32_Share ‚Üí List all network shares
Get-WmiObject Win32_ServerConnection ‚Üí Show current network sessions
Get-WmiObject Win32_NetworkConnection ‚Üí View mapped network drives


üí° Other Useful Utilities

whoami /groups ‚Üí Show user group memberships
nltest /dclist:domain ‚Üí List domain controllers
net config workstation ‚Üí Show computer name and joined domain
net time \server ‚Üí Test time synchronization with a server
nslookup ‚Üí Perform DNS lookup
ping ‚Üí Test reachability and latency
tracert ‚Üí Trace network route to a host
pathping ‚Üí Combined ping + traceroute diagnostics


https://learn.microsoft.com/en-us/sysinternals/downloads/tcpview



-- Windows Process Analysis -- 

‚öôÔ∏è Process Management

tasklist ‚Üí Show all running processes
taskkill /PID 1234 /F ‚Üí Forcefully terminate a process by PID
tasklist /V ‚Üí Display detailed process info (memory, user, status)
tasklist /M ‚Üí Show which DLL modules each process has loaded

tasklist /M /FI "PID eq 2088" ‚Üí Show DLLs used by process with PID 2088
tasklist /FI "PID eq 2088" ‚Üí Show info only for PID 2088
tasklist /FI "IMAGENAME eq notmaleware.exe" ‚Üí Show info for a specific executable
tasklist /M /FI "PID eq 2088" ‚Üí List modules associated with the given process

Get-Process ‚Üí Show all running processes (like tasklist)
Stop-Process -Id 1234 -Force ‚Üí Forcefully terminate a process by PID (like taskkill /PID 1234 /F)
Get-Process | Sort-Object CPU -Descending ‚Üí Sort processes by CPU usage
Get-Process | Select-Object Name,Id,CPU,StartTime ‚Üí Display selected process details
Get-Process -Name notepad ‚Üí Show info for a specific process

Get-Process | Where-Object { $_.Id -eq 2088 } ‚Üí Filter process by PID
Get-Process | Where-Object { $_.Name -like "malware" } ‚Üí Search for suspicious process names


üåê Network Connections (Related to Processes)

netstat -ano ‚Üí Display all connections with owning process IDs
netstat -anob | findstr ESTABLISHED ‚Üí Show only established connections with process info

Get-NetTCPConnection ‚Üí Show active TCP connections (similar to netstat -ano)
Get-NetTCPConnection | Where-Object { $_.State -eq "Established" } ‚Üí Show established sessions only
Get-NetUDPEndpoint ‚Üí Display active UDP listeners
Get-NetTCPConnection | Select-Object LocalAddress,LocalPort,RemoteAddress,OwningProcess ‚Üí Show connection + PID mapping
Get-Process -Id (Get-NetTCPConnection | Where-Object { $_.RemotePort -eq 80 }).OwningProcess ‚Üí Identify which process owns a specific connection


üîß Windows Services and Components

sc query ‚Üí List all running and stopped services with current status

wmic service list brief ‚Üí Display a concise list of all services
wmic useraccount list full ‚Üí Show detailed information about user accounts

Get-Service ‚Üí List all Windows services and their status (like sc query)
Get-Service | Where-Object { $_.Status -eq 'Running' } ‚Üí Show only running services
Restart-Service -Name spooler ‚Üí Restart a service by name
Stop-Service -Name wuauserv -Force ‚Üí Stop Windows Update service
Set-Service -Name wuauserv -StartupType Disabled ‚Üí Disable a service from auto-starting
Get-WmiObject Win32_Service | Select Name,State,StartMode,PathName ‚Üí Display full details of each service


üß† Process Investigation (WMIC-Based)

wmic process list brief ‚Üí List processes with PID, command line, and parent info
wmic process where processid=2088 get Name,ParentProcessId,ProcessId ‚Üí Get process name and hierarchy for PID 2088
wmic process get Name,ParentProcessId,ProcessId | find "192" ‚Üí Search processes by number or string
wmic process where processid=2088 get CommandLine ‚Üí Show full command line for process 2088
wmic process where "name='cmd.exe'" get ProcessId,ParentProcessId,CommandLine ‚Üí Get process tree for specific executable

Get-WmiObject Win32_Process ‚Üí List all processes with detailed info
Get-WmiObject Win32_Process -Filter "ProcessId=2088" | Select Name,ParentProcessId,ProcessId ‚Üí Get parent-child hierarchy for PID 2088
Get-WmiObject Win32_Process | Where-Object { $_.CommandLine -like "192" } ‚Üí Search processes for IPs or commands
Get-WmiObject Win32_Process -Filter "Name='cmd.exe'" | Select ProcessId,ParentProcessId,CommandLine ‚Üí Inspect a specific process
Get-CimInstance Win32_Process | Select Name,ProcessId,ParentProcessId,CommandLine ‚Üí Newer alternative to WMIC


üß© System Startup and Persistence

wmic startup get Caption,Command,Location ‚Üí Show programs configured to run at startup
start msconfig ‚Üí Open System Configuration utility (startup/services control)
reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Run ‚Üí Check startup entries in registry

Get-CimInstance Win32_StartupCommand | Select Name,Command,Location,User ‚Üí Show startup items for all users
Get-ItemProperty 'HKLM:\Software\Microsoft\Windows\CurrentVersion\Run' ‚Üí Check system-wide startup programs
Get-ItemProperty 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Run' ‚Üí Check per-user startup programs
Get-ScheduledTask | Where-Object { $_.State -eq 'Ready' } ‚Üí List all scheduled tasks that could persist malware
Get-Service | Where-Object { $_.StartType -eq 'Automatic' } ‚Üí Identify services that start automatically


üß± Common Persistence Registry Paths

HKLM\Software\Microsoft\Windows\CurrentVersion\Run ‚Üí Programs that auto-start for all users
HKCU\Software\Microsoft\Windows\CurrentVersion\Run ‚Üí Programs that auto-start for current user
HKLM\SYSTEM\CurrentControlSet\Services\ ‚Üí Services that start automatically with Windows
HKLM\Software\Microsoft\Active Setup\Installed Components ‚Üí Components that execute once per user login
HKCU\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\Shell ‚Üí Custom shell entries that can persist malware


üí° Additional Useful PowerShell Tools

Get-WmiObject Win32_StartupCommand ‚Üí List startup commands with paths and locations
Get-EventLog -LogName Security -Newest 20 ‚Üí Review recent security events
Get-ScheduledTask ‚Üí View all scheduled tasks
Get-LocalUser ‚Üí List local user accounts
Get-LocalGroupMember Administrators ‚Üí List users in the Administrators group
Get-HotFix ‚Üí Show installed patches and updates


https://www.revshells.com/



-- Windows Core Processes -- 

Process Investigation
‚Ä¢ Parent Process: Check if hierarchy matches the expected chain (e.g., wininit ‚Üí services ‚Üí svchost).
‚Ä¢ Child Process: Look for suspicious spawns (e.g., svchost starting cmd.exe).
‚Ä¢ Command Line Arguments: Review parameters (e.g., svchost -k netsvcs).
‚Ä¢ Process Names: Watch for typos or fake copies (e.g., svch0st.exe).
‚Ä¢ User Account: Confirm process runs under the expected account.
‚Ä¢ Image Path: Validate that it matches the real system directory (not %TEMP% or AppData).


- Windows Core Process Hierarchy (Boot to User Session) -

System
‚Ä¢ Kernel-mode system thread (manages CPU, memory, and drivers)
‚Ä¢ Image Path: None (or C:\Windows\System32\ntoskrnl.exe)
‚Ä¢ PID: 4
‚Ä¢ Parent: None (System Idle Process)
‚Ä¢ Number of Instances: 1
‚Ä¢ User Account: Local System
‚Ä¢ Start Time: At boot

smss.exe (Session Manager Subsystem)
‚Ä¢ Manages user sessions and launches system processes
‚Ä¢ Spawns: wininit.exe, csrss.exe
‚Ä¢ Image Path: %SystemRoot%\System32\smss.exe
‚Ä¢ Parent: System (PID 4)
‚Ä¢ Number of Instances: 1 master, 1 child per session (child self-terminates)
‚Ä¢ User Account: Local System
‚Ä¢ Start Time: Within seconds of boot

csrss.exe (Client/Server Runtime Subsystem)
‚Ä¢ Handles console windows, Windows API DLLs, and GUI shutdown tasks
‚Ä¢ Image Path: %SystemRoot%\System32\csrss.exe
‚Ä¢ Parent: smss.exe (orphan process)
‚Ä¢ Number of Instances: Two or more
‚Ä¢ User Account: Local System
‚Ä¢ Instances: Two or more
‚Ä¢ Start Time: Within seconds of boot

wininit.exe (Windows Initialization)
‚Ä¢ Initializes system services (Session 0)
‚Ä¢ Spawns: services.exe, lsass.exe
‚Ä¢ Image Path: %SystemRoot%\System32\wininit.exe
‚Ä¢ Parent: smss.exe (orphan process)
‚Ä¢ Number of Instances: 1
‚Ä¢ User Account: Local System
‚Ä¢ Start Time: Within seconds of boot

services.exe (Service Control Manager)
‚Ä¢ Manages starting, stopping, and interaction of Windows services
‚Ä¢ Updates the LastKnownGood CurrentControlSet registry value for recovery.
‚Ä¢ Spawns: multiple svchost.exe instances
‚Ä¢ Image Path: %SystemRoot%\System32\services.exe
‚Ä¢ Parent: wininit.exe
‚Ä¢ User Account: Local System
‚Ä¢ Start Time: Within seconds of boot

svchost.exe (Service Host)
‚Ä¢ Hosts and manages Windows service DLLs
‚Ä¢ Runs with -k parameter to separate service groups
‚Ä¢ Image Path: %SystemRoot%\System32\svchost.exe
‚Ä¢ Parent: services.exe
‚Ä¢ Number of Instances: Many (typically 10+)
‚Ä¢ User Account: Local System / Network Service / Local Service / User
‚Ä¢ Start Time: Seconds after boot or when services start

lsass.exe (Local Security Authority Subsystem Service)
‚Ä¢ Authenticates users and enforces local security policies
‚Ä¢ Writes events to the Security Event Log
‚Ä¢ Image Path: %SystemRoot%\System32\lsass.exe
‚Ä¢ Parent: wininit.exe
‚Ä¢ Number of Instances: 1
‚Ä¢ User Account: Local System
‚Ä¢ Start Time: Within seconds of boot

winlogon.exe (Windows Logon)
‚Ä¢ Manages logon/logoff procedures
‚Ä¢ Loads user profiles (NTUSER.DAT)
‚Ä¢ Responds to Secure Attention Sequence (Ctrl+Alt+Del)
‚Ä¢ Image Path: %SystemRoot%\System32\winlogon.exe
‚Ä¢ Parent: smss.exe (orphan process)
‚Ä¢ Number of Instances: 1 or more
‚Ä¢ User Account: Local System
‚Ä¢ Start Time: Within seconds of boot (Session 1)

explorer.exe (Windows Explorer)
‚Ä¢ Provides desktop, taskbar, Start menu, and file management GUI
‚Ä¢ Image Path: %SystemRoot%\explorer.exe
‚Ä¢ Parent: userinit.exe (orphan process)
‚Ä¢ Number of Instances: 1 or more
‚Ä¢ User Account: Logged-in user
‚Ä¢ Start Time: When interactive session begins


üß© What is an "orphan process"

An "orphan process" is a process whose parent process has already terminated ‚Äî but the process itself is still running. The parent process is gone, but the child process continues running.

Example in Windows Boot

Let‚Äôs take userinit.exe ‚Üí explorer.exe as an example:
When a user logs in, winlogon.exe launches userinit.exe.
userinit.exe starts the user‚Äôs desktop environment by launching explorer.exe (the GUI).
Once explorer.exe is successfully running, userinit.exe exits (terminates).
explorer.exe keeps running ‚Äî but now it has no living parent process.
‚Üí So it becomes an orphan process.

Parent Process: userinit.exe (orphan process)

‚úÖ Legitimate orphan (normal) ‚Üí System boot or user logon ‚Äî processes like csrss.exe, wininit.exe, userinit.exe, or explorer.exe often become orphans naturally.
‚ö†Ô∏è Suspicious orphan (abnormal) ‚Üí Malware sometimes kills its parent process intentionally to hide its execution chain, leaving itself as an orphan ‚Äî which can make it harder to trace how it started.



-- The Windows Registry --  

The registry on any Windows system contains the following five root keys:

‚Ä¢ HKEY_CURRENT_USER
‚Ä¢ HKEY_USERS
‚Ä¢ HKEY_LOCAL_MACHINE
‚Ä¢ HKEY_CLASSES_ROOT
‚Ä¢ HKEY_CURRENT_CONFIG

HKEY_CURRENT_USER
‚Ä¢ Path: HKCU\
‚Ä¢ Purpose: Settings specific to the currently logged-in user
‚Ä¢ Important Subkeys:
  ‚Üí HKCU\Software\Microsoft\Windows\CurrentVersion\Run ‚Üí User-specific persistence
  ‚Üí HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\RecentDocs ‚Üí Recent file access ‚Äî useful in timeline analysis
  ‚Üí HKCU\Software\Microsoft\Windows\Shell\BagMRU ‚Üí User interaction with folders
  ‚Üí HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\ComDlg32\OpenSavePidlMRU ‚Üí Files recently accessed via open/save dialogs

HKEY_USERS
‚Ä¢ Path: HKU\<UserSID>\
‚Ä¢ Purpose: Contains user profile settings for all users
‚Ä¢ Useful for: Accessing another user‚Äôs HKCU equivalent when they are not logged in
‚Ä¢ Important Subkeys:
  ‚Üí Look for same keys as in HKCU, but under each SID (e.g., S-1-5-21-...).

HKEY_LOCAL_MACHINE
‚Ä¢ Path: HKLM\
‚Ä¢ Purpose: Contains configuration data for the entire system, hardware, drivers, services, and installed software
‚Ä¢ Important Subkeys:
  ‚Üí HKLM\SYSTEM\CurrentControlSet\Services\ ‚Üí Malicious drivers, unauthorized services, Attackers may create or modify services for persistence
  ‚Üí HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run ‚Üí Auto-start entries ‚Üí Used for persistence by malware
  ‚Üí HKLM\SAM ‚Üí Windows account credentials (protected) ‚Üí Accessed during credential dumping attacks (e.g., Mimikatz)
  ‚Üí HKLM\SECURITY ‚Üí LSA secrets, cached credentials ‚Üí Targeted in credential attacks

HKEY_CLASSES_ROOT
‚Ä¢ Path: HKCR\
‚Ä¢ Purpose: File association and COM object settings
‚Ä¢ Important Subkeys:
  ‚Üí Used in DLL hijacking or COM hijacking
  ‚Üí Malware may register malicious DLLs here for persistence

HKEY_CURRENT_CONFIG
‚Ä¢ Path: HKCC\
‚Ä¢ Purpose: Dynamic configuration data ‚Äî hardware profile used at startup.
‚Ä¢ Less relevant for persistence or IOC detection, but helpful for understanding device context.


Tips for SOC Analysts
‚Ä¢ Use tools like:
  ‚Üí RegRipper, Autoruns, Sysinternals, FTK Imager, Velociraptor, KAPE
‚Ä¢ Correlate registry findings with:
  ‚Üí Event logs (EVTX)
  ‚Üí File system artifacts ($MFT, prefetch, shimcache)
  ‚Üí Memory analysis
‚Ä¢ Watch for anomalies like:
  ‚Üí Suspicious Run keys pointing to non-standard paths
  ‚Üí Services with strange names or binaries in C:\Users\ or AppData
  ‚Üí Unexpected registry changes outside patch windows


- How to correlate registry findings with event logs, file system artifacts, and memory analysis -

Goal: When you find a suspicious registry entry (e.g., a persistence key or malware path), correlate it with other artifacts to determine when, how, and by whom it was created or executed.

üß© 1. Registry Findings
You find this registry key: HKCU\Software\Microsoft\Windows\CurrentVersion\Run
‚Üí Value: updatetool.exe = "C:\Users\Admin\AppData\Roaming\update.exe"

This means there‚Äôs an autostart entry. Now you need to verify:
‚Ä¢ When was it created?
‚Ä¢ Which user or process created it?
‚Ä¢ Does the file update.exe actually exist?
‚Ä¢ Was it ever executed?

üßæ 2. Correlate with Event Logs (EVTX)
Tools: Event Viewer, wevutil, EvtxECmd, or Chainsaw
Goal: Find log entries showing creation, modification, or execution of the related file or process.

Useful log sources:
‚Ä¢ Security.evtx ‚Üí Logons, process creation (Event ID 4688)
‚Ä¢ System.evtx ‚Üí Service and driver events
‚Ä¢ Application.evtx ‚Üí Application-related events
‚Ä¢ Microsoft-Windows-PowerShell/Operational ‚Üí Script activity

Search for process creation events:
Event ID 4688 ‚Üí New Process Created
Command Line: C:\Users\Admin\AppData\Roaming\update.exe

üíæ 3. Correlate with File System Artifacts

Tools:
‚Ä¢ MFTECmd.exe ‚Üí Analyze $MFT (Master File Table)
‚Ä¢ PECmd.exe ‚Üí Parse Prefetch files
‚Ä¢ AppCompatCacheParser.exe ‚Üí Extract ShimCache entries
‚Ä¢ Timeline Explorer / Autopsy ‚Üí Build timelines

$MFT: Tracks file creation, modification, and deletion	update.exe created: 2025-10-12
Prefetch: Shows if and when an executable was run	UPDATE.EXE-123456.pf ‚Üí run count: 3
ShimCache: Indicates that Windows has previously loaded the file	update.exe last seen: 2025-10-12 09:32

This confirms execution evidence, timing, and frequency.

üß¨ 4. Correlate with Memory Analysis

Tools: Volatility3, Rekall
Goal: Find traces of running or recently terminated processes, handles, and network connections.

Volatility:
vol.py -f memory.dmp windows.pslist | findstr update.exe
vol.py -f memory.dmp windows.cmdline
vol.py -f memory.dmp windows.netscan

Results:
‚Ä¢ update.exe running under user Admin
‚Ä¢ Command line: C:\Users\Admin\AppData\Roaming\update.exe
‚Ä¢ Network connection: 185.192.xxx.xxx:443
‚û° Confirms the process was active in memory and had network activity.

üìÖ 5. Correlate into a Unified Timeline
Use tools like Timeline Explorer, Timesketch, or even Excel to align timestamps from:
‚Ä¢ Registry hives
‚Ä¢ Event logs
‚Ä¢ File system artifacts
‚Ä¢ Memory dumps

Example timeline:
09:32 - Prefetch shows update.exe executed
09:33 - Security log (4688): Process created
09:34 - Registry key added to Run
09:35 - update.exe connects to 185.192.xxx.xxx
‚û° This builds the full attack chain ‚Äî persistence ‚Üí execution ‚Üí network activity.


- Windows Registry via CLI -

reg [add|delete|query|copy|save|load|unload|restore|compare|export|import] <KeyName> [Options]

reg query "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run"
reg add "HKCU\Software\TestKey" /v "MaliciousRun" /t REG_SZ /d "C:\Evil\malware.exe" /f
reg delete "HKCU\Software\TestKey" /f
reg delete "HKCU\Software\TestKey" /v "MaliciousRun" /f
reg export "HKCU\Software\Microsoft\Windows\CurrentVersion\Run" C:\runkey_backup.reg
reg import C:\runkey_backup.reg
reg compare "HKCU\Software\Microsoft" "HKLM\Software\Microsoft"



-- Windows Autoruns -- 

Autostart Programs (Autoruns) 
NTUSER.DAT\Software\Microsoft\Windows\CurrentVersion\Run
NTUSER.DAT\Software\Microsoft\Windows\CurrentVersion\RunOnce
SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce
SOFTWARE\Microsoft\Windows\CurrentVersion\policies\Explorer\Run
SOFTWARE\Microsoft\Windows\CurrentVersion\Run

Autorun Registry Keys
HKCU\Software\Microsoft\Windows\CurrentVersion\Run
HKCU\Software\Microsoft\Windows\CurrentVersion\RunOnce
HKLM\Software\Microsoft\Windows\CurrentVersion\Run
HKLM\Software\Microsoft\Windows\CurrentVersion\RunOnce

Service Configuration Keys
HKLM\SYSTEM\CurrentControlSet\Services\{ServiceName}

Scheduled Tasks
%SystemRoot%\System32\Tasks
HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Schedule\TaskCache

Suspicious Registry Indicators
%TEMP%, %APPDATA%, %PUBLIC%, %USERPROFILE%
UNC paths (\\192.168.x.x\share\malware.exe)

Windows CLI
reg add [RootKey\SubKey] /v ValueName /t Type /d Data [/f]
reg query [RootKey\SubKey] [/v ValueName] [/s]
reg query "HKCU\Software\Microsoft\Windows\CurrentVersion\Run"
reg query "HKLM\Software\Microsoft\Windows\CurrentVersion\Run"
reg query "HKCU\Software\Microsoft\Windows\CurrentVersion\Run" /v OneDrive
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion" /s

reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Run" /v MyTool /t REG_SZ /d "C:\Tools\mytool.exe" /f
reg add "HKLM\Software\Microsoft\Windows\CurrentVersion\RunOnce" /v TempScript /t REG_SZ /d "C:\Temp\script.bat" /f

PowerShell
Get-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Run"
Get-ItemProperty -Path "HKLM:\Software\Microsoft\Windows\CurrentVersion\Run"
Get-ItemProperty -Path "Registry::HKCU\Software\Microsoft\Windows\CurrentVersion\Run"
Get-ItemProperty -Path "Registry::HKLM\Software\Microsoft\Windows\CurrentVersion\Run"
Set-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Run" -Name "MyTool" -Value "C:\Tools\mytool.exe"
New-Item -Path "HKCU:\Software\MyMalware" -Force
New-ItemProperty -Path "HKCU:\Software\MyMalware" -Name "Payload" -Value "evil.exe" -PropertyType String



-- Windows Service Analysis --  

services.msc

Get-Service
Get-Service -Name Spooler
Get-Service -Name W*  

Get-Service | Where-Object { $_.Status -eq 'Running' }
Get-Service | Where-Object { $_.Status -eq 'Stopped' }
Get-Service | Where-Object { $_.DisplayName -like "*Windows Update*" }

Get-Service | Sort-Object Status, DisplayName
Get-Service | Sort-Object Status | Format-Table -AutoSize

Get-Service | Format-Table Name, DisplayName, Status, StartType

Get-WmiObject -Class Win32_Service | Select Name, DisplayName, StartMode, State, StartName, PathName
Get-WmiObject -Class Win32_Process | Select Name, ProcessId, ExecutablePath, CommandLine

Get-WmiObject Win32_Service | Select-Object Name, DisplayName, StartMode, StartName, State, PathName

Get-WmiObject -Class Win32_ComputerSystem | Select UserName
Get-WmiObject -Class Win32_Product | Select Name, Version, InstallDate

Get-WmiObject -Class Win32_NetworkAdapterConfiguration | Where-Object { $_.IPEnabled -eq $true } | Select Description, IPAddress, DefaultIPGateway, MACAddress
Get-WmiObject -Class Win32_OperatingSystem | Select Caption, Version, BuildNumber, LastBootUpTime
Get-WmiObject -Class Win32_StartupCommand | Select Name, Command, Location
Get-WmiObject -Class Win32_Service -Filter "Name = 'SuspiciousService'" | Format-List *

Get-WmiObject Win32_Service | Where-Object { $_.PathName -match "Users|AppData|Temp" } | Format-Table Name, PathName, StartName

Get-CimInstance -ClassName Win32_Service

Detection Tip:

‚Ä¢ C:\Users, C:\Users\Public, %TEMP%, %APPDATA%
‚Ä¢ With no digital signature
‚Ä¢ Sysmon Event ID 13, Registry Key Creation
‚Ä¢ Get-WinEvent -LogName System | Where-Object { $_.Id -eq 7045 } | Select TimeCreated, Message



-- Windows Scheduled Tasks --  

C:\Windows\System32\Tasks\

HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Schedule\TaskCache\Tasks\


CLI:
schtasks /query /fo LIST /v
schtasks /query /tn "TaskName" /v /fo LIST

schtasks /delete /tn "BadTask" /f

Create Scheduled Task:
schtasks /create /tn "<TaskName>" /tr "<Command>" /sc <Schedule> [options]
schtasks /create /tn "DailyBackup" /tr "C:\Scripts\backup.bat" /sc daily /st 09:00
schtasks /create /tn "UpdateHelper" /tr "C:\Users\Public\payload.exe" /sc onlogon /ru SYSTEM
schtasks /create /tn "MonitorCheck" /tr "C:\Tools\monitor.exe" /sc hourly
schtasks /create /tn "WinUpdateCheck" /tr "powershell.exe -WindowStyle Hidden -ExecutionPolicy Bypass -File C:\Users\Public\up.ps1" /sc onlogon /ru SYSTEM

One time ‚Üí once
Every day ‚Üí daily
Every week ‚Üí weekly
At logon ‚Üí onlogon
At idle ‚Üí onidle
At startup ‚Üí onstart
Repeats ‚Üí /mo (modifier), e.g. /sc minute /mo 5 = every 5 minutes


PowerShell:
Get-ScheduledTask
Get-ScheduledTask -TaskName "TaskName" | Get-ScheduledTaskInfo
Unregister-ScheduledTask -TaskName "BadTask" -Confirm:$false

Get-ScheduledTask | Where-Object { $_.Actions.Execute -match "AppData|Temp|powershell|cmd" }



-- Windows Event Logs --  

4720: A user account was created
4722: A user account was enabled
4723: An attempt was made to change an account's password
4724: An attempt was made to reset an account's password
4738: A user account was changed
4725: A user account was disabled
4726: A user account was deleted
4732: A member was added to a security-enabled local group
4688: A new process has been created
1102: The audit log was cleared

7045: A service was installed in the system
7030: The Service Control Manager tried to take a corrective action (Restart the service)
7035: The Service Control Manager is transitioning services to a running state
7036: The Service Control Manager has reported that a service has entered the running state

Critical Security Event IDs:
4624	Successful logon
4625	Failed logon
4634	Logoff
4648	Logon using explicit credentials
4670	Permission on object changed
4688	New process creation
4697	Service installation
4720	User account created
4722	User account enabled
4723	Password change
4740	Account locked out
1102	Security log cleared (highly suspicious)
4723/4724	Password change/reset

Start ‚Üí Run ‚Üí eventvwr.msc
eventvwr

- Key Event Log Categories -

Security: Authentication, authorization, and audit logs (e.g., logons, privilege use)
System: OS-level operations (e.g., driver failure, shutdown, restart)
Application: App-specific events (e.g., errors, crashes)
Setup: Windows setup and updates
Forwarded Events: Logs from other systems (if configured via WEC)

- wevtutil for SOC Analysten -

wevtutil qe Security
wevtutil qe Security /c:10 /f:text
wevtutil qe Security /c:10 /f:text /rd:true
wevtutil qe Security /c:10 /f:text /rd:true /q:"[System[(EventID=4624)]]"
wevtutil qe Security "/q:*[System[(EventID=4624)]]" /f:text
wevtutil qe Security /c:50 /f:text | findstr /i "4625"

- Get-WinEvent PowerShell for SOC Analysts -

Get-WinEvent -LogName System
Get-WinEvent -LogName Security
Get-WinEvent -LogName Security | Where-Object {$_.Id -eq 4625}

Get-WinEvent -FilterHashtable @{logname="Security"; ID=4625}
Get-WinEvent -FilterHashtable @{logname='Security'; ID=4624} -MaxEvents 2 | Format-List *
Get-WinEvent -FilterHashtable @{LogName="Security"; Id=4624} | Select-Object TimeCreated, Id, Message

Get-WinEvent -Path "C:\Windows\System32\winevt\Logs\Security.evtx"
Get-WinEvent -LogName System -MaxEvents 10
Get-WinEvent -LogName Security | Where-Object {$_.Message -like "*admin*"}

$ids = 4624, 4625, 4634
Get-WinEvent -FilterHashtable @{LogName='Security'; Id=$ids}
Get-WinEvent -FilterHashtable @{LogName="Security"; Id=4740} | Select-Object TimeCreated, Message

Get-WinEvent -ListLog *
Get-WinEvent -ListLog Setup | Format-List -Property *
Get-WinEvent -ListLog * -ComputerName localhost | Where-Object { $_.RecordCount }

Get-WinEvent -ListProvider *
(Get-WinEvent -ListLog Application).ProviderNames

Get-WinEvent -ListProvider *Policy*
(Get-WinEvent -ListProvider Microsoft-Windows-GroupPolicy).Events | Format-Table Id, Description

$Event = Get-WinEvent -LogName 'Windows PowerShell'
$Event.Count
$Event | Group-Object -Property Id -NoElement | Sort-Object -Property Count -Descending
$Event | Group-Object -Property LevelDisplayName -NoElement

Get-WinEvent -Path 'C:\Windows\System32\winevt\Logs\Windows PowerShell.evtx'
Get-WinEvent -Path "C:\Windows\System32\winevt\Logs\Microsoft-Windows-PowerShell%4Operational.evtx" -MaxEvents 100



-- Sysmon --  

sysmon.exe -accepteula -i sysmonconfig-export.xml
sysmon.exe -c sysmonconfig-export.xml
sysmon.exe -u

- Sysmon Events -

Event ID 1: Process Creation
Event ID 1: Process Creation
Event ID 3: Network ConnectionEvent ID 5: Process Terminated
Event ID 7: Image Loaded
Event ID 8: CreateRemoteThread
Event ID 10: ProcessAccess
Event ID 11: FileCreate
Event ID 12: RegistryEvent (Object Create and Delete)
Event ID 13: RegistryEvent (Value Set)
Event ID 14: RegistryEvent (Key and Value Rename)
Event ID 15: FileCreateStreamHash
Event ID 22: DNSEvent (DNS query)
Event ID 27: FileBlockExecutable
Event ID 29: FileExecutableDetected

- Powershell -

Get-WinEvent -LogName "Microsoft-Windows-Sysmon/Operational" -> View all Sysmon logs

Get-Process | Where-Object { $_.CPU -gt 100 } | Select-Object Name, CPU -> Monitor suspicious processes with high CPU usage

Get-NetTCPConnection | Where-Object { $_.State -eq 'Listen' } | Select-Object LocalAddress, LocalPort -> Check for open/listening TCP ports

Get-ItemProperty "HKLM:\Software\Microsoft\Windows\CurrentVersion\Uninstall\*" | Select-Object DisplayName, DisplayVersion -> Scan installed software and versions for vulnerabilities

Get-WinEvent -FilterHashtable @{LogName='Security'; ID=4625} | Select-Object TimeCreated, Id, LevelDisplayName, Message -> Extract failed login events (Event ID 4625)

Get-WinEvent -FilterHashtable @{LogName="Microsoft-Windows-Sysmon/Operational"; Id=1} -> View Sysmon process creation events (Event ID 1)

Get-WinEvent -FilterHashtable @{logname="Microsoft-Windows-Sysmon/Operational"; id=3} -MaxEvents 1 | Format-List * -> Show the most recent network connection event (Sysmon Event ID 3) with all details

Get-WinEvent -LogName 'Microsoft-Windows-Sysmon/Operational' -FilterXPath "*[System/EventID=3 and EventData[Data[@Name='DestinationPort']='4444']]" | Format-List * -> Filter Sysmon network connection events (ID 3) where DestinationPort = 4444

Get-WinEvent -LogName 'Microsoft-Windows-Sysmon/Operational' -FilterXPath "*[System/EventID=1 and EventData[Data[@Name='ProcessId']='4584']]" | Format-List * -> Get process creation events (Event ID 1) where ProcessId = 4584



-- Linux Network Analysis -- 

netstat -tulnp           
netstat -an              
netstat -rn             
netstat -s            

netstat -tn
netstat -tnp
netstat -antup

ss -tulnp                 
ss -an                   
ss -s                

ss -tnp
ss src 127.0.0.1
ss dst 127.0.0.1
ss sport == 4444 -tnp
ss dport == 4444 -tnp

lsof
lsof -u root
lsof -i          
lsof -i :80      
lsof -nP -i      
lsof -p 3610     
lsof -iTCP -sTCP:LISTEN    -
lsof +L1

sha256sum <hash_value>



-- Linux Process Analysis --  

ps -aux    
ps -ef   
ps -u root
ps -AFH 
ps -AFH | less

ps -p 3610
ps -p 3610 -F
ps --ppid 2941

pstree
pstree -p -s 3610

top
top -u root -c 
top -u root -c -o -TIME+

/proc$ ls -la
/proc$ ls -la exe
/proc$ strings exe

/proc/3160$ cat env
/proc/3160$ cat env | tr '\0' '\n'



-- Linux Cron Jobs --  

crontab -l                     
crontab -e                      
crontab -r                     
crontab -u <user> -l           
ls -la /var/spool/cron/crontabs    


- System-Wide Cron Jobs -

cat /etc/crontab               
ls /etc/cron.d/                
ls /etc/cron.{hourly,daily,weekly,monthly} 


- Loggingg & Debugging -

grep CRON /var/log/syslog      
tail -f /var/log/cron         
journalctl -u cron            


- Cron Syntax Strukture -

# ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Minute (0 - 59)
# ‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Hour (0 - 23)
# ‚îÇ ‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Day of month (1 - 31)
# ‚îÇ ‚îÇ ‚îÇ ‚îå‚îÄ‚îÄ‚îÄ Month (1 - 12)
# ‚îÇ ‚îÇ ‚îÇ ‚îÇ ‚îå‚îÄ Day of week (0 - 6) (Sunday=0 or 7)
# ‚îÇ ‚îÇ ‚îÇ ‚îÇ ‚îÇ
# * * * * *  command_to_execute


- Examples -

0 5 * * * /usr/bin/backup.sh             -- Every day at 5:00 AM  
*/10 * * * * /usr/bin/check_disk.sh      -- Every 10 minutes  
0 0 * * 0 /usr/bin/weekly_report.sh      -- Every Sunday at midnight  
0 12 1 * * /usr/bin/monthly_cleanup.sh   -- On the 1st of each month at 12:00 PM  


- Environment Variables in Cron -

SHELL=/bin/bash
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin


