
--- Phishing Analysis ---

‚Ä¢ Email Fundamentals  
‚Ä¢ Phishing Attack Types  
‚Ä¢ Phishing Attack Techniques  
‚Ä¢ Email Analysis Methodology  
‚Ä¢ Email Header and Sender Analysis  
‚Ä¢ Email Authentication Methods  
‚Ä¢ Email Content Analysis  
‚Ä¢ The Anatomy of a URL  
‚Ä¢ Email URL Analysis  
‚Ä¢ Email Attachment Analysis  
‚Ä¢ Dynamic Attachment Analysis and Sandboxing  
‚Ä¢ Static MalDoc Analysis  
‚Ä¢ Static PDF Analysis  
‚Ä¢ Automated Email Analysis with PhishTool  
‚Ä¢ Reactive Phishing Defense
‚Ä¢ Proactive Phishing Defense  
‚Ä¢ Phishing Analysis Report Template



-- Email Fundamentals --

EMAIL FLOW (ASCII)

Sender (Bob)                  Bob's Mail Server                 Alice's Mail Server                 Recipient (Alice)
+-------------+               +-------------------+             +--------------------+              +--------------+
|  Bob        | -- SMTP --->  |  Gmail / SMTP MX  | -- SMTP --> |  Yahoo / SMTP MX   | -- POP3/IMAP|   Alice      |
|  (Sender)   |               |  (outbound MTA)   |             |  (inbound MTA)     | <----------- |  (Recipient) |
+-------------+               +-------------------+             +--------------------+              +--------------+

Legend:
- SMTP: Simple Mail Transfer Protocol (sending/relaying mail between servers)
- POP3/IMAP: Protocols used by the recipient to retrieve mail from their mail server

Bob (the sender) writes an email and sends it using his mail service (e.g., Gmail).  
Gmail‚Äôs server sends the message via SMTP across the internet to Alice‚Äôs mail server (e.g., Yahoo).  
Alice then connects to her Yahoo mailbox using POP3 or IMAP to receive and read Bob‚Äôs email.


‚Ä¢ Email Headers: Email headers are lines of metadata attached to an email and contain useful information like sender, receiver, subject, and mail servers.
‚Ä¢ Email Body: The email body is the main part of the email that the receiver reads and contains the message, links, images, or attachments.

‚Ä¢ SMTP (Simple Mail Transfer Protocol) ‚Äì 25 (default), 465 or 587 (secure)
‚Ä¢ POP3 (Post Office Protocol v3) ‚Äì 110 (default), 995 (secure)
‚Ä¢ IMAP (Internet Message Access Protocol) ‚Äì 143 (default), 993 (secure)


EMAIL FLOW WITH MAIL AGENTS (ASCII)

   [ Bob - Sender ]                        [ Mail Servers / Internet ]                     [ Alice - Recipient ]
+--------------------+                +------------------------+                    +-----------------------+
| Mail User Agent    | --SMTP-->      | Mail Transfer Agents   | --SMTP-->          | Mail Delivery Agent   |
| (MUA - e.g. Gmail) |                | (MTA - route messages) |                    | (MDA - inbox handler) |
+--------------------+                +------------------------+                    +-----------------------+
         |                                                                              |
         |                                                                              |
         +---------------------------- POP3 / IMAP ------------------------------------+
                                    (Mail Retrieval Agent - MRA)


MUA (Mail User Agent) ‚Äì Used by the user to write, send, and read emails.
‚Üí Example: Gmail, Outlook, Yahoo, Thunderbird

MSA (Mail Submission Agent) ‚Äì Takes the email from the MUA and sends it to the first mail server using SMTP.

MTA (Mail Transfer Agent) ‚Äì Transfers and routes the email across multiple mail servers until it reaches the recipient‚Äôs server.
‚Üí Example: Postfix, Sendmail, Exim

MDA (Mail Delivery Agent) ‚Äì Accepts the message from the MTA and puts it into the recipient‚Äôs mailbox.
‚Üí Example: Procmail, Dovecot LDA

MRA (Mail Retrieval Agent) ‚Äì Allows the recipient to fetch or sync their emails from the mailbox using POP3 or IMAP.
‚Üí Example: Outlook IMAP, Apple Mail, Thunderbird

-----------------------------------------------------------
Simple Explanation:
Bob writes an email using Gmail (MUA).  
The Mail Submission Agent (MSA) sends it to Gmail‚Äôs server.  
Mail Transfer Agents (MTAs) pass the message across the internet until it reaches Yahoo‚Äôs mail server.  
The Mail Delivery Agent (MDA) places it into Alice‚Äôs inbox.  
Finally, Alice‚Äôs email client (MRA) retrieves the email using POP3 or IMAP so she can read it.
-----------------------------------------------------------

An email moves from the sender‚Äôs client through mail agents (MSA ‚Üí MTA ‚Üí MDA ‚Üí MRA) using SMTP and is retrieved by the recipient with POP3 or IMAP.



-- Phishing Attack Types --  

‚Ä¢ Information Gathering / Recon ‚Äì Collecting information about targets to create realistic phishing emails.
‚Ä¢ Credential Harvesting ‚Äì Stealing usernames and passwords through fake login pages or deceptive links.
‚Ä¢ Malware Delivery ‚Äì Sending malicious attachments or links that install malware.
‚Ä¢ Spear Phishing ‚Äì Highly targeted phishing aimed at specific people or organizations.
‚Ä¢ Whaling ‚Äì Phishing attacks aimed at high-profile individuals like CEOs or executives.
‚Ä¢ Vishing / SMiShing / Quishing ‚Äì Using phone calls, SMS, or QR codes to trick users into giving information.
‚Ä¢ Business Email Compromise (BEC) ‚Äì Using real or stolen business accounts to send fraudulent requests or scams.
‚Ä¢ Spam ‚Äì Unwanted or irrelevant bulk emails, usually without direct malicious intent.



-- Phishing Attack Techniques --  

‚Ä¢ Pretexting ‚Äì Creating a fake story or reason to trick someone into giving information.
‚Ä¢ Spoofing and Impersonation ‚Äì Faking an email address or domain to look like a trusted person or company.
‚Ä¢ URL Manipulation ‚Äì Using fake or shortened links to hide the real malicious website.
‚Ä¢ Encoding ‚Äì Hiding malicious code or URLs using Base64, HTML, or JavaScript encoding to avoid detection.
‚Ä¢ Attachments ‚Äì Sending files that the victim downloads and runs to install malware.
‚Ä¢ Abuse of Legitimate Services ‚Äì Using trusted sites like Google Drive or Dropbox to deliver malicious content.
‚Ä¢ Pharming ‚Äì Redirecting users to fake websites by poisoning DNS or using malware to steal data.



-- Email Analysis Methodology -- 

‚Ä¢ Initial Triage ‚Äì Quickly check the email and decide how serious and urgent it is.
‚Ä¢ Header and Sender Examination ‚Äì Look at sender details, IPs, and mail servers to find the real source.
‚Ä¢ Content Examination ‚Äì Read the email text to spot fake language, tone, formatting or social engineering tricks.
‚Ä¢ Web and URL Examination ‚Äì Collect and analyze all links and domains used in the email.
‚Ä¢ Attachment Examination ‚Äì Safely extract and check attached files for malware or sandbox behavior.
‚Ä¢ Contextual Examination ‚Äì Compare with other incidents to see if it‚Äôs part of a bigger campaign.
‚Ä¢ Defense Measures ‚Äì Take needed actions like blocking domains, alerting users, or resetting passwords.
‚Ä¢ Documentation and Reporting ‚Äì Record all findings, actions, and outcomes in a report and close the



-- Email Header and Sender Analysis --  

Look at these key points to find the true sender and verify authenticity:

‚Ä¢ Date and Time: The exact date and time the email was sent; check for inconsistencies or delays between hops.
‚Ä¢ From: The sender‚Äôs display name and email address (can be spoofed in phishing attempts).
‚Ä¢ To: The recipient‚Äôs email address showing who the message was intended for.
‚Ä¢ Subject: The subject line of the email, giving an idea of the message‚Äôs content.
‚Ä¢ Return-Path: The real address used for mail delivery or bounces; useful for tracing the sending server.
‚Ä¢ Sender: Address that appears to have sent the message.
‚Ä¢ Reply-To: The address replies will go to (can differ from From; often abused in phishing).
‚Ä¢ Message-ID: A unique identifier created by the sending mail server to track the message‚Äôs journey.
‚Ä¢ Received: Lists all servers and IPs the email passed through; unexpected hops may indicate spoofing.
‚Ä¢ Authentication-Results: Displays SPF, DKIM, and DMARC check results.
‚Ä¢ SPF Result: Tells if the sender‚Äôs IP is authorized to send for that domain.
‚Ä¢ DKIM Signature: Confirms if the message content and sender domain are genuine.
‚Ä¢ DMARC Policy: Defines how the receiving server should handle SPF/DKIM failures.
‚Ä¢ Originating IP Address: The first external IP in the Received chain (actual sending source).
‚Ä¢ Mail Server Hostnames: The domain names of each mail server in the route.
‚Ä¢ X-Headers: Custom headers added by servers or gateways (e.g., X-Originating-IP, X-Mailer) that may reveal the original sending system or tools.
‚Ä¢ X-Sender-IP: Reveals the real IP address of the sender; useful for tracing origin and identifying malicious hosts.


X-Headers (Extended Email Headers)

‚Ä¢ X-Headers are custom fields added by mail servers, gateways, or security tools. They provide valuable forensic information about the origin, transmission, and filtering of an email ‚Äî often used to detect spoofing, phishing, or spam activity.
‚Ä¢ X-Originating-IP ‚Äì Shows the IP address of the computer or network that originally sent the email. Example: X-Originating-IP: [192.168.1.10]
‚Ä¢ X-Sender-IP ‚Äì Reveals the real IP address of the sender; useful for tracing origin and identifying malicious hosts. Example: X-Sender-IP: 209.85.128.170
‚Ä¢ X-Mailer ‚Äì Indicates the email client or software used to send the email (e.g., Outlook, Thunderbird, PHP mailer). Example: X-Mailer: Microsoft Outlook 16.0
‚Ä¢ X-Spam-Flag ‚Äì Indicates whether an email was flagged as spam by the mail server‚Äôs spam filter. Example: X-Spam-Flag: YES
‚Ä¢ X-DKIM-Signature ‚Äì Contains the DKIM signature used to verify message authenticity. Example:


How to Analyze the "Received" Chain:
‚Ä¢ Read from Bottom to Top: The bottom-most ‚ÄúReceived‚Äù header shows the first mail server that handled the email, while the top one shows the final server that delivered it to the recipient.
‚Ä¢ Check for Unexpected Hops: If there are unknown, mismatched, or suspicious servers in the chain, it may indicate tampering, relaying through unauthorized systems, or redirection by malicious actors.
‚Ä¢ Verify IP Addresses and Domains: Cross-check each IP address and domain with trusted sources (e.g., WHOIS, DNS records, or internal threat intel) to confirm they belong to legitimate mail servers.

Why it matters:
‚Ä¢ Analyzing the ‚ÄúReceived‚Äù headers helps uncover spoofing attempts, misconfigured domains, or phishing attacks.
‚Ä¢ Validating these entries against SPF, DKIM, and DMARC records strengthens confidence in the email‚Äôs authenticity.


cat sample.eml | less
grep -i "from:" sample.eml
grep -i "received" sample.eml
grep -i "spf" sample.eml
grep -i "dmarc" sample.eml
grep -i "dkim" sample.eml


https://www.iana.org/assignments/message-headers/message-headers.xhtml
https://whois.domaintools.com/
https://mha.azurewebsites.net/
https://github.com/microsoft/MHA
https://mxtoolbox.com/EmailHeaders.aspx
https://toolbox.googleapps.com/apps/messageheader/
http://mailheader.org/
https://testconnectivity.microsoft.com/tests/exo



-- Email Authentication Methods -- 

Email Authentication Methods (SPF, DKIM, DMARC)

SPF (Sender Policy Framework) ‚Äì Checks if the sending mail server is authorized for the domain.
‚û°Ô∏è Uses DNS records listing valid sender IPs.
‚úÖ Pass if IP matches, ‚ùå Fail if not in record.

Received-SPF: pass (google.com: domain of example.com designates 192.168.1.20 as permitted sender) client-ip=192.168.1.20;


DKIM (DomainKeys Identified Mail) ‚Äì Confirms message integrity and sender authenticity.
‚û°Ô∏è Email is signed with a private key; recipient verifies using a public key in DNS.
‚úÖ Pass if signature valid, ‚ùå Fail if modified.

DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=example.com; s=selector1;
 h=from:subject:date:message-id;
 bh=AbCdEfGh1234567890==;
 b=RANDOMLONGENCRYPTEDSIGNATURE==


DMARC (Domain-based Message Authentication, Reporting & Conformance) ‚Äì Enforces SPF/DKIM checks and gives reporting visibility.
‚û°Ô∏è DNS policy tells how to handle failed messages (none / quarantine / reject).
‚úÖ Pass if SPF or DKIM align with the ‚ÄúFrom‚Äù domain.

Authentication-Results: mx.google.com;
 spf=pass smtp.mailfrom=example.com;
 dkim=pass header.d=example.com;
 dmarc=pass (p=REJECT sp=REJECT dis=NONE) header.from=example.com


>> Email Authentication Verification Commands <<

  SPF (Sender Policy Framework)
----------------------------------

# Check SPF record for a domain
nslookup -type=txt namecheap.com
nslookup -type=txt namecheap.com | grep -i spf

dig TXT namecheap.com | grep -i spf
dig @8.8.8.8 -t txt namecheap.com
dig @8.8.8.8 -t txt namecheap.com | grep spf

# Check included SPF records
nslookup -type=txt _spf.sendgrid.net | grep -i spf
dig TXT _spf.google.com | grep -i spf
host -t txt example.com | grep -i spf

curl -s https://dns.google/resolve?name=example.com&type=TXT | jq '.Answer[] | select(.data | test("spf"))'

# Example Output
shodan.io text = "v=spf1 ip4:216.117.2.180 ip4:69.72.37.146 include:_spf.google.com -all"

# Interpretation
v=spf1       ‚Üí SPF version
ip4:         ‚Üí Authorized sending IPs
include:     ‚Üí Reference another domain‚Äôs SPF record
-all         ‚Üí Hard fail (reject unauthorized senders)
~all         ‚Üí Soft fail (mark as suspicious, don‚Äôt reject)


  DKIM (DomainKeys Identified Mail)
--------------------------------------

# Check DKIM record (replace selector1 with actual selector name)
nslookup -type=txt selector1._domainkey.namecheap.com
dig selector1._domainkey.namecheap.com TXT

dig selector1._domainkey.example.com TXT +short | awk -F'p=' '{print length($2)}'

# Example Output
v=DKIM1; k=rsa; p=MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQC1LfA...

# Interpretation
v=DKIM1  ‚Üí DKIM version
k=rsa    ‚Üí Key type
p=       ‚Üí Public key for verifying DKIM signature


  DMARC (Domain-based Message Authentication, Reporting & Conformance)
-------------------------------------------------------------------------

# Check DMARC record
nslookup -type=txt _dmarc.namecheap.com
dig _dmarc.namecheap.com TXT

curl -s https://dns.google/resolve?name=_dmarc.example.com&type=TXT | jq '.Answer[]'

# Example Output
v=DMARC1; p=reject; rua=mailto:dmarc-reports@yourdomain.com

# Interpretation
v=DMARC1  ‚Üí DMARC version
p=        ‚Üí Policy (none / quarantine / reject)
rua=      ‚Üí Reporting address for DMARC aggregate reports

SPF   ‚Üí Verifies if the sender server is authorized to send mail for the domain.
DKIM  ‚Üí Confirms message integrity and authenticity using digital signatures.
DMARC ‚Üí Enforces SPF/DKIM checks and defines policy for failed authentication.


https://mxtoolbox.com/EmailHeaders.aspx
https://mxtoolbox.com/dkim.aspx
https://mxtoolbox.com/dmarc.aspx
https://defang.me/



-- Email Content Analysis -- 

Look at these key points to identify phishing or malicious intent:

Email Body: ‚Äì Main text of the message; check for urgency, fear, or financial requests.
Language and Tone: ‚Äì Poor grammar, unusual phrasing, or unnatural urgency.
Links: ‚Äì Hover to see the real URL; watch for misspelled domains or redirects.
Attachments: ‚Äì Mentioned but missing, or attached with suspicious names/extensions.
Logos and Branding: ‚Äì Slight visual changes or wrong colors/fonts can indicate fakes.
Sender Signature: ‚Äì Check if the signature matches the claimed company format.
Requests for Action: ‚Äì Login links, payments, data updates ‚Äî red flags for phishing.
Embedded Code: ‚Äì Hidden HTML, JavaScript, or base64 content in the message source.
Mismatch: ‚Äì Visible URL ‚â† actual hyperlink destination.
Social Engineering: ‚Äì Emotional pressure, authority impersonation, or urgency tactics.


MIME Analysis (Multipurpose Internet Mail Extensions):

MIME-Version: ‚Äì Defines which MIME protocol version is used.
Content-Type: ‚Äì Specifies the email format (plain text, HTML, or multipart with attachments).
Content-Transfer-Encoding: ‚Äì Shows how content is encoded (Base64, quoted-printable, etc.).
MIME Boundary: ‚Äì Separates multiple parts of an email (plain text vs. HTML or attachments).
‚û°Ô∏è Used to detect hidden payloads or extra HTML content that doesn‚Äôt appear in the plain-text view.


Red Flags
- Organization name mismatch.
- Awkward greetings or inconsistent sender identity.
- Social engineering tactics (urgency, fear, pressure, or authority).
- Poor grammar, spelling mistakes, or formatting inconsistencies.

Encoding Types (Common Obfuscation Techniques)
- Base64 Encoding: ‚Äì Encodes attachments or hides scripts within HTML or MIME parts.
- HTML Entity Encoding: ‚Äì Masks malicious code or links inside HTML text.
- URL Encoding: ‚Äì Hides phishing URLs or redirects inside encoded characters (%2E, %2F, etc.).


CyberChef: ‚Äì Decode and analyze encoded content.
- Decode Base64 strings to reveal hidden data.
- Deobfuscate encoded URLs or HTML entities.
- Visualize and extract hidden scripts or payloads.


- Email Content Analysis Examples -

Hiding Malicious URLs within Legitimate-Looking Links Example: 
<a href="https://malicious-site.com">https://legitimate-site.com</a>

URL Encoding Example:
https://malicious-site.com/badstuff
https://malicious-site.com/%62%61%64%73%74%75%66

Base64 Encoding Example:
https://malicious-site.com/badstuffaHR0cHM6Ly9tYWxpY2lvdXMtc2l0ZS5jb20vYmFkc3R1ZmY=

Combining Both Techniques ‚Äì Hidden and Encoded Link Example:
<a href="https://malicious-site.com/%62%61%64%73%74%75%66">Click here to update your account</a>
https://malicious-site.com/%62%61%64%73%74%75%66

Using CyberChef to Decode Encoded URLs: aHR0cHM6Ly9tYWxpY2lvdXMtc2l0ZS5jb20vYmFkc3R1ZmY=

1. Go to CyberChef (https://gchq.github.io/CyberChef/)
2. Use "From Base64"
3. Paste the Base64-encoded URL
4. Click "Bake!"
5. Decoded result ‚Üí https://malicious-site.com/badstuff

https://gchq.github.io/CyberChef/
https://www.w3schools.com/html/html_entities.asp



-- The Anatomy of a URL -- 

https://blog.raminzamani.com:443/6-parts-of-a-url?utm_source=linkedin&utm_medium=organic#definition

https://blog.raminzamani.com:443/6-parts-of-a-url?utm_source=linkedin&utm_medium=organic#definition
‚îÇ        ‚îÇ                   ‚îÇ   ‚îÇ                   ‚îÇ                             ‚îÇ
‚îÇ        ‚îÇ                   ‚îÇ   ‚îÇ                   ‚îÇ                             ‚îî‚îÄ Fragment: #definition
‚îÇ        ‚îÇ                   ‚îÇ   ‚îÇ                   ‚îî‚îÄ Query String: ?utm_source=linkedin&utm_medium=organic
‚îÇ        ‚îÇ                   ‚îÇ   ‚îî‚îÄ Path: /6-parts-of-a-url
‚îÇ        ‚îÇ                   ‚îî‚îÄ Port: 443
‚îÇ        ‚îî‚îÄ Hostname: blog.raminzamani.com
‚îÇ             ‚îú‚îÄ Subdomain: blog
‚îÇ             ‚îú‚îÄ Main Domain: raminzamani
‚îÇ             ‚îî‚îÄ TLD: com
‚îî‚îÄ Protocol: https



-- Email URL Analysis -- 

Email URL Analysis is the process of examining links found in emails to detect signs of phishing, malicious redirects, or other security risks.

Domain Name: ‚Äì Check spelling, typos, special characters, or extra subdomains.
Redirects: ‚Äì Identify short URLs or multi-hop redirects that hide the real site.
Registration Details: ‚Äì Use WHOIS to see domain age, registrar, and ownership.
SSL Certificate: ‚Äì Verify the certificate issuer, validity, and domain match.
Hosting IP: ‚Äì Check IP reputation, geolocation, and ASN ownership.
Path and Parameters: ‚Äì Watch for encoded, obfuscated, or long random strings.
Protocol Used: ‚Äì HTTP vs HTTPS; missing HTTPS may indicate fake sites.
Redirection Behavior: ‚Äì Observe how the site redirects when opened safely.

üîπ Safe Handling of Links
- Never click suspicious links directly.
- Right-click ‚Üí "Copy Link Location" to inspect safely.
- Always analyze URLs in an isolated or sandboxed environment.

üîπ Using Sublime Text
- Open the .eml file in Sublime Text.
- Search for "http" or "https" to locate embedded URLs.
- The <p> tag shows normal paragraph text.
- Look for <a> tags to reveal hidden or disguised links.
- The <a href="..."> tag shows the actual hyperlink destination (which may differ from the visible text).
- This method allows visual inspection without activating the URL.
   
   <p>Need to access Google? <a href="https://www.google.com">Just click this text!</a></p>


üîπ Using CyberChef
- Tool: https://gchq.github.io/CyberChef/
- Useful operations:
  - "From Quoted Printable" ‚Üí Decode encoded email content.
  - "Extract URLs" ‚Üí List all URLs from the message.
  - "Defang URL" ‚Üí Safely modify links (e.g., hxxps[:] instead of https://).
- Helps decode and examine malicious links securely.


cat sample.eml | grep -i "<a href"
cat sample.eml | grep -i "http"
cat sample.eml | grep -oP 'https?://\S+'

strings sample.eml | grep -i "http"
strings sample.eml | grep -oP 'https?://\S+'

curl -I <URL>
nslookup <domain>
whois <domain>
dig +short <domain>


Using Email IOC Extractor
A Python script for automatic extraction of Indicators of Compromise (IOCs) from email files.

$ python3 eioc.py <file_path>

$ python3 eioc.py sample1.eml

Extracted IP Addresses:
====================================
209[.]85[.]128[.]170 - Atlanta, Georgia, US, ISP: AS15169 Google LLC
10[.]13[.]153[.]59

Extracted URLs:
====================================
hxxps[://]drive[.]google[.]com/file/d/1sdzd_hr-_bEt_tJabjINZfvYiOvEJjSJ
hxxps[://]apply-submite[.]vercel[.]app/

Extracted Headers:
====================================
Date: Mon, 31 Oct 2022 11:53:21 +0300
Subject: [Action required] Verify your info to continue using your account
From: Ropo12g Gaming <jodykrier60@gmail.com>
Return-Path: jodykrier60@gmail.com
X-Sender-IP: 209.85.128.170
Authentication-Results: spf=pass (sender IP is 209.85.128.170)

Extracted Attachments:
====================================
Filename: 3spyWy0D.pdf
MD5: 42f1cb17cee1027608917094c3fe99b9
SHA256: 6bd89500da5666a9444d2cd9af7a1fe4c945ea9fb31562d97018fdb2799dbda3

üîπ Notes:
- Defang URLs (e.g., hxxp:// or [.] instead of .com) before sharing.
- Cross-check domains on threat intelligence platforms (VirusTotal, URLScan, AbuseIPDB).
- Record all findings (URLs, IPs, hashes) in your case documentation.


Analyze URL Reputation Check

https://gchq.github.io/CyberChef/
https://github.com/MalwareCube/Email-IOC-Extractor
https://phishtank.org/
https://www.url2png.com/
https://urlscan.io/
https://www.virustotal.com/gui/home/upload
https://www.urlvoid.com/
https://www.wannabrowser.net/
https://unshorten.it/
https://urlhaus.abuse.ch/
https://urlhaus.abuse.ch/browse/
https://urlhaus.abuse.ch/feeds/
https://www.abuseipdb.com/
https://transparencyreport.google.com/safe-browsing/search
https://www.joesandbox.com/



-- Email Attachment Analysis --  

Analyzing email attachments helps identify hidden malware or phishing payloads.

Look at these key points to identify malware or hidden payloads:

File Name and Extension: ‚Äì Suspicious, double extensions, or disguised file types.
File Size and Metadata: ‚Äì Check for unusual size or metadata inconsistencies.
Hashes: ‚Äì Calculate MD5, SHA1, SHA256 for reputation or VirusTotal checks.
Macros or Scripts: ‚Äì Analyze with olevba or oledump for malicious code.
File Type Verification: ‚Äì Use file or exiftool to confirm actual file format.
PDF Objects: ‚Äì Check with pdfid or pdf-parser for JavaScript or embedded files.
Sandbox Behavior: ‚Äì Observe processes, connections, and dropped files.
Content Match: ‚Äì Confirm attachments match what the email claims.

üîπ Common Attachment Types üîπ

Documents: .pdf, .docx, .xlsx, .pptx
‚ö†Ô∏è May contain malicious macros or embedded scripts.

Images: .jpg, .png, .gif
‚ö†Ô∏è Could hide steganography or injected payloads.

Compressed Archives: .zip, .rar, .7z
‚ö†Ô∏è Often used to conceal multiple files or executables.

Executables: .exe, .bat, .sh, .msi
‚ö†Ô∏è High risk of malware, trojans, or ransomware.

Scripts: .js, .vbs, .ps1
‚ö†Ô∏è Can execute dangerous code automatically.

Emails: .eml, .msg
‚ö†Ô∏è May include phishing or malicious links.

Multimedia: .mp3, .wav, .mkv
‚ö†Ô∏è Can contain hidden malicious payloads.

- Extracting Attachments (Static Analysis) -

python3 emldump.py sample1.eml
python3 emldump.py sample1.eml -s 4 -d > quotation.iso

python3 eioc.py sample1.eml

file attachment.iso

sha256sum quotation.iso
sha1sum quotation.iso
md5sum quotation.iso

sha256sum quotation.iso && sha1sum quotation.iso && md5sum quotation.iso

Get-FileHash .\quotation.iso # default is SHA256
Get-FileHash -Algorithm MD5 .\quotation.iso
Get-FileHash -Algorithm SHA1 .\quotation.iso
Get-FileHash -Algorithm SHA256 .\quotation.iso

Get-FileHash -Algorithm MD5 .\quotation.iso; Get-FileHash -Algorithm SHA1 .\quotation.iso; Get-FileHash -Algorithm SHA256 .\quotation.iso


File Reputation Services:

https://github.com/DidierStevens/DidierStevensSuite/blob/master/emldump.py
https://github.com/MalwareCube/Email-IOC-Extractor
https://www.virustotal.com/gui/home/upload
https://talosintelligence.com/
https://any.run



-- Dynamic Attachment Analysis and Sandboxing --  

Sandboxing is a controlled, isolated environment used to safely execute and observe suspicious files.  
It allows analysts to detect malicious behavior (processes, network calls, file changes) without risking production systems.

üîπ What to Look for During Sandboxing üîπ 

Process Activity:
- Monitor spawned or unexpected processes.
- Track process tree, memory usage, and privilege escalation.
- Identify suspicious process hierarchies (e.g., cmd.exe ‚Üí powershell.exe ‚Üí mshta.exe).

Registry Activity:
- Observe new or modified registry keys.
- Detect persistence mechanisms (e.g., Run/RunOnce entries).
- Flag registry changes linked to known malware behavior.

Network Activity:
- Watch for outbound connections to suspicious IPs or domains.
- Detect potential C2 (Command & Control) communication.
- Identify DNS requests or download attempts for secondary payloads.

File Activity:
- Track file creation, deletion, modification, or encryption.
- Detect dropped executables or temporary hidden files.
- Watch for ransomware-like behavior (file encryption, renaming).

Benefits of Sandboxing
- Isolation ‚Äì Malware executes safely without spreading.
- Behavioral Insight ‚Äì Detects threats based on activity, not just signatures.
- Automated Reporting ‚Äì Generates detailed logs and behavioral summaries for further analysis.

Recommended Sandboxing Tools
- Cuckoo Sandbox ‚Äì Open-source automated malware analysis.
- Any.Run ‚Äì Interactive, cloud-based real-time analysis.
- Joe Sandbox ‚Äì Advanced static/dynamic behavior analytics.
- Hybrid Analysis ‚Äì Cloud service combining multiple detection engines.

Analyst Notes
- Always hash the file before sandboxing (MD5, SHA1, SHA256).
- Upload only non-confidential samples to cloud sandboxes.
- Review process, file, and network behavior in sandbox reports.
- Correlate sandbox IOCs (IPs, domains, hashes) with threat intelligence feeds.

Sandboxing provides safe behavioral analysis of suspicious attachments, helping detect and contain threats before they impact your environment.


https://hybrid-analysis.com/
https://cuckoo.cert.ee/
https://joesandbox.com
https://app.any.run
https://cloud.google.com/blog/topics/threat-intelligence/cve-2017-0199-hta-handler
https://medium.com/@asmcybersecurity/diving-deeper-into-the-microsoft-office-cve-2017-0199-vulnerability-11bd3e725ab7



-- Static MalDoc Analysis --  

Static MalDoc Analysis examines potentially malicious documents (Word, Excel, PDF, etc.) without executing them. It focuses on identifying embedded macros, scripts, and objects that could deliver or hide malware.

üîπKey Focus Areasüîπ 

Metadata Review: Check file properties (author, creation date, last modified, etc.) for anomalies or tampering.
Macro Inspection: Extract and analyze VBA macros embedded in Office files. Look for suspicious keywords like: Shell, PowerShell, WScript, CreateObject, AutoOpen.
OLE Stream Analysis: Inspect Object Linking and Embedding (OLE) structures for hidden or malicious streams.
Embedded Objects: Identify executables, scripts, or URLs embedded within the document.
Obfuscation Detection: Decode or decompress obfuscated VBA or encoded payloads to reveal malicious code.

What is OLE
Object Linking and Embedding (OLE) is a Microsoft technology that allows documents to embed or link to other objects (images, spreadsheets, executables, etc.).  
Attackers often abuse OLE to hide scripts or drop malware through embedded objects or macros.

python3 oledump.py --help

python3 oledump.py sample1.xlsm ‚Üí List all OLE streams in the document ‚Üí "M" indicates a macro stream (e.g., Stream 4)
python3 oledump.py sample1.xlsm -s 4 ‚Üí Extract a specific macro from stream 4
python3 oledump.py sample1.xlsm -s 4 -v ‚Üí Extract and display the content of a specific stream.
python3 oledump.py sample1.xlsm -s 4 -S ‚Üí Extract readable strings from the macro
python3 oledump.py sample1.xlsm -s 4 --vbadecompresscorrupt ‚Üí Decompress or decode corrupted VBA macros

python3 oledump.py sample1.xlsm -a ‚Üí Displays all OLE objects with automatic analysis.
python3 oledump.py sample1.xlsm -i ‚Üí Show file metadata, including authorship and modification timestamps
python3 oledump.py sample1.xlsm -t ‚Üí Show all streams with indicators for macro content.
python3 oledump.py sample1.xlsm -S ‚Üí Show the detailed structure of an OLE file
python3 oledump.py sample1.xlsm -p plugin ‚Üí Uses a specific plugin to analyze the file.



# Identify file type and format
file sample1.xlsm
file quotation.iso
file suspicious.doc

# Extract readable text strings (useful for detecting URLs, macros, PowerShell)
strings sample1.xlsm | less
strings -n 6 sample1.xlsm | grep -Ei "http|https|cmd|powershell|wscript|shell"

# View ASCII and hex representation of the file
xxd sample1.xlsm | head -50

# Check for embedded URLs, IPs, or suspicious patterns
grep -Eo "(http|https)://[a-zA-Z0-9./?=_-]*" sample1.xlsm
grep -Eo "[0-9]{1,3}(\.[0-9]{1,3}){3}" sample1.xlsm

# Analyze metadata (creation time, author, last modified)
exiftool sample1.xlsm
exiftool sample1.pdf

# Detect OLE objects or embedded streams (manual verification)
oleid sample1.xlsm
oledir sample1.xlsm

# Extract possible Base64-encoded payloads
grep -Eo "([A-Za-z0-9+/]{20,}={0,2})" sample1.xlsm | head -20

# Detect suspicious macros or embedded scripts (VBA-related)
strings sample1.xlsm | grep -Ei "AutoOpen|Shell|CreateObject|Execute|PowerShell"

# View summary information for Office files
olemeta sample1.xlsm

# (Optional) Generate file hashes for comparison / sandbox upload
md5sum sample1.xlsm
sha256sum sample1.xlsm

Static MalDoc Analysis reveals hidden malicious behavior before execution, reducing risk and supporting early detection.

https://blog.didierstevens.com/programs/oledump-py/
https://github.com/DidierStevens/DidierStevensSuite/blob/master/oledump.py



-- Static PDF Analysis --  

Static PDF Analysis examines PDF documents without opening or executing them. The goal is to identify malicious elements like embedded scripts, JavaScript, or hidden links by analyzing structure, metadata, and embedded objects.

What to Look For
- Embedded JavaScript or Launch actions
- Hidden URLs or external links
- Embedded files (attachments)
- Suspicious metadata (creator, modification time)
- Unusual object structure or obfuscation


‚Ä¢ pdf-parser is a Python tool for inspecting internal PDF structure ‚Äî objects, streams, and embedded elements (URIs, JavaScript, etc.).

Basic usage:
python3 pdf-parser.py pdf-doc-vba-eicar-dropper.pdf
python3 pdf-parser.py pdf-doc-vba-eicar-dropper.pdf | more

Search for embedded URLs: python3 pdf-parser.py book04-02.4422136363.pdf -s "/URI"

Search for JavaScript: python3 pdf-parser.py book04-02.4422136363.pdf -s "/JavaScript"

Extract an embedded file: python3 pdf-parser.py pdf-doc-vba-eicar-dropper.pdf --object 8 --filter --raw --dump eicar-dropper.doc


‚Ä¢ pdfid provides a quick overview of the PDF‚Äôs structure and potential red flags (JavaScript, embedded files, launch actions).

Run analysis: python3 pdfid.py pdf-doc-vba-eicar-dropper.pdf

Example output includes:
  /JavaScript
  /OpenAction
  /AA
  /EmbeddedFile

Other Useful Commands

Check file type: file eicar-dropper.doc

Analyze embedded OLE objects (if present): python3 oledump.py eicar-dropper.doc

Analyst Notes:
‚Ä¢ Run pdfid first for a quick scan, then use pdf-parser for detailed inspection.
‚Ä¢ Look for suspicious actions like '/Launch', '/URI', '/JavaScript', or '/EmbeddedFile'.
‚Ä¢ If extraction reveals other document types (e.g., .doc, .xls), analyze them separately using oledump.py or oletools.
‚Ä¢ Never open suspect PDFs directly on a production host ‚Äî use isolated VMs.


https://github.com/DidierStevens/DidierStevensSuite/blob/master/pdf-parser.py
https://github.com/DidierStevens/DidierStevensSuite/blob/master/pdfid.py



-- Automated Email Analysis with PhishTool -- 

When a phishing incident is detected, take immediate reactive steps to contain, remove, and recover from the threat.

Containment
- Determine scope of the phishing incident (users, systems, emails involved).
- Quarantine affected mailboxes or devices.
- Block sender domains and email addresses.
- Block associated URLs and web artifacts in proxies/firewalls.
- Block or hash-block malicious attachments across EDR and AV.

Eradication
- Remove malicious emails (via Content Search / eDiscovery in M365 or mail gateway).
- Remove any malicious files from infected hosts.
- Revoke or reset compromised credentials.
- Investigate and remove abuse form submissions (phishing landing pages).
- Reimage compromised systems if needed.

Recovery
- Restore affected systems or accounts from known clean backups.
- Validate that no persistence or backdoors remain.
- Re-enable quarantined services only after verification.

Communication
- Notify affected users about the incident and recommended actions.
- Update internal stakeholders and management with a summary of scope and remediation.
- Coordinate with IT, IR, and threat intel teams for cross-verification.

User Education
- Conduct targeted user awareness training post-incident.
- Share phishing examples and prevention best practices.
- Reinforce safe email handling and reporting procedures.


https://www.phishtool.com/



-- Reactive Phishing Defense --  

Remove Malicious Emails: Use PowerShell‚Äôs Get-MessageTrackingLog to trace the delivery path of phishing emails, identify affected recipients, and confirm successful removal from mailboxes.

# Install the module if you haven‚Äôt already
Install-Module ExchangeOnlineManagement -Force

# Import the module (good practice)
Import-Module ExchangeOnlineManagement

# Connect to Exchange Online
Connect-ExchangeOnline -UserPrincipalName your_admin_account@yourdomain.com

PS > Get-MessageTrace -RecipientAddress user@example.com

PS > Connect-ExchangeOnline -UserPrincipalName user@example.com

PS > Get-MessageTrace -RecipientAddress user@example.com -StartDate "05/05/2025" -EndDate "05/06/2025"

PS > Get-MessageTrackingLog -Sender "attacker@attacker.com"
PS > Get-MessageTrackingLog -Recipients "victim@victim.com"
PS > Get-MessageTrackingLog -Sender "attacker@attacker.com" -MessageSubject "Hello"
PS > Get-MessageTrackingLog -Start "MM/DD/YYYY HH:MM:SS" -End "MM/DD/YYYY HH:MM:SS"


# Find All Emails from a Sender
Get-MessageTrackingLog -Start "10/01/2024 00:00:00" -End "10/03/2024 23:59:59" -Sender "user@example.com"

# Track an Email to a Specific Recipient
Get-MessageTrackingLog -Start "10/01/2024 00:00:00" -End "10/03/2024 23:59:59" -Recipients "recipient@example.com"

# Find Emails with a Specific Subject
Get-MessageTrackingLog -Start "10/01/2024 00:00:00" -End "10/03/2024 23:59:59" -MessageSubject "Invoice Due"

# Search for Specific Event Types (e.g., Received Emails)
Get-MessageTrackingLog -Start "10/01/2024 00:00:00" -End "10/03/2024 23:59:59" -EventId "RECEIVE"

# Find Messages by Message ID
Get-MessageTrackingLog -MessageId "<messageid@domain.com>"

# Filter Logs by Client IP Address
Get-MessageTrackingLog -Start "10/01/2024 00:00:00" -End "10/03/2024 23:59:59" -ClientIp "192.168.1.10"

# Find the Last 100 Emails
Get-MessageTrackingLog -Start "10/01/2024 00:00:00" -End "10/03/2024 23:59:59" -ResultSize 100


Get-MessageTrackingLog | Out-Host ‚ÄìPaging
Get-MessageTrackingLog | Format-Table ‚ÄìAutoSize
Get-TransportServer | Get-MessageTrackingLog

Get-MessageTrackingLog -Start (Get-Date).AddHours(-24) -ResultSize unlimited | where {[string]$_.recipients -like "*@gmail.com"}

Get-MessageTrackingLog -ResultSize unlimited ‚ÄìSender "cmansion@woshub.com‚Äù ‚Äìserver rome-hub-01 -Start "11/30/2019 06:00:00" -End "12/13/2019 22:00:00" |select-object Timestamp,Sender,Recipients,MessageSubject,EventId|ft

Get-MessageTrackingLog -Sender "cmansion@woshub.com" -Recipients "amorato@woshub.com" -ResultSize unlimited ‚Äìserver rome-hub-01| Select-Object Timestamp,Sender,{$_.recipients},MessageSubject | Export-Csv -Path "C:\Export\exchange\exchange_tracking_logs.csv" -Encoding Default -Delimiter ";"

Get-MessageTrackingLog -MessageSubject "test" -ResultSize unlimited ‚Äìserver rome-hub-01| Select-Object Timestamp,Sender, {$_.recipients}, MessageSubject | out-gridview

Get-MessageTrackingLog -messageID "41A4321C3543314FFFFF23122F2BDB7ABD00342@rome-hub-01.woshub.com" -ResultSize unlimited ‚Äìserver rome-hub-01| Select-Object Timestamp,Sender, {$_.recipients}, MessageSubject

(Get-MessageTrackingLog -EventID "RECEIVE" -Recipients "amorato@woshub.com" -ResultSize unlimited).Count

Get-MessageTrackingLog -EventId "Receive" -Start (Get-Date).AddDays(-5) -ResultSize Unlimited | Where-Object {$_.Sender -like "*@gmail.com"} | Group-Object Sender | Sort-Object Count -Descending | Format-Table *



-- Proactive Phishing Defense ---

Proactive phishing defense focuses on preventing phishing emails from reaching users and reducing overall attack exposure through layered protection and awareness.

Email Filtering
‚Ä¢ Use email security appliances (e.g., Proofpoint, Microsoft Defender, Mimecast) to detect and block known malicious senders.
‚Ä¢ Enable tagging of external emails to warn users when messages originate outside the organization.

URL Scanning and Blocking
‚Ä¢ Enable real-time URL inspection in the mail gateway to detect malicious links before delivery.
‚Ä¢ Block recently registered or suspicious domains using threat intelligence and domain reputation feeds.

Attachment Filtering
‚Ä¢ Apply file extension blocking for risky file types (.exe, .js, .vbs, .iso, .scr).
‚Ä¢ Use sandboxing to detonate and analyze attachments before delivering them to users.

Email Authentication Methods
‚Ä¢ Implement SPF, DKIM, and DMARC to authenticate legitimate senders and block spoofed emails.
‚Ä¢ Regularly review DMARC reports to detect unauthorized use of your domain.

User Training
‚Ä¢ Conduct security awareness training on identifying phishing emails and reporting them safely.
‚Ä¢ Perform phishing simulation exercises to test and improve employee awareness.
‚Ä¢ Provide a reporting function (e.g., "Report Phish" button) for users to escalate suspicious messages to SOC.


https://whois.domaintools.com/



-- Phishing Analysis Report Template --  


Headers
======================================
Date:
Subject:
To:
From:
Reply-To:
Return-Path:
Sender IP:
Resolve Host:
Message-ID:


URLs
=======================================


Attachments
======================================
Attachment Name:
MD5:
SHA1:
SHA256:


Description
======================================


Artifact Analysis
======================================
Sender Analysis:
URL Analysis:
Attachment Analysis:


Conclusion
======================================


Defense Actions
======================================



--------------------------------------------------------------------------------------------------------------------



























































































+++++++++++++++++++++++
